#!/bin/bash
_CURRENT_FILE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
_CURRENT_RUNNING_DIR="$( cd "$( dirname "." )" && pwd )"


. "${_CURRENT_FILE_DIR}/stella-link.sh" include

. "${_CURRENT_FILE_DIR}/lib/lib.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_json.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_vscode.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_gemini.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_opencode.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_mcp.sh"

# --- USAGE ---
usage() {
    cat << EOF
IATools

Usage: iatools [options]

Options:
    init                    Install/Reinstall dependencies.
    help                    Display this help message.
    shell                   Enter iatools context and path.
    ----
    gc : gemini-cli - https://google-gemini.github.io/gemini-cli
    gc install [@version]           Install and configure Gemini CLI. (main versions are latest, nightly, preview) (when asked to relaunch gemini cli, use 'iatools gc launch' command)
    gc uninstall                    Uninstall Gemini CLI (keeping all configuration unchanged. to remove configuration use 'iatools gc reset' command)
    gc configure                    Configure Gemini CLI. ('iatools gc install' include configuration)
    gc show-config                  Show current Gemini CLI configuration.
    gc reset                        Reset all Gemini CLI configuration.
    gc launch [context folder] -- <other gemini options>                  
                                    Launch Gemini CLI. You can use 'gemini' command in your terminal
                                    put in your PATH ${IATOOLS_GEMINI_LAUNCHER_HOME}
                                    done by default in vscode terminal.
    gc mcp calculator install|uninstall         Add mcp-calculator local server configuration.
    gc mcp github install|uninstall             Add mcp-github remote server configuration.
    gc mcp desktop-commander install|uninstall  Add mcp-desktop-commander local server configuration.
    gc mcp context7 install|uninstall   [CONTEXT7_API_KEY]        Add mcp-context7 local server configuration. Provide optional CONTEXT7_API_KEY as environment variable or command argument.
    gc mcp data commons install|uninstall [DC_API_KEY]          Add mcp-data-commons remote server configuration. Provide mandatory DC_API_KEY from https://apikeys.datacommons.org/ as environment variable or command argument.
    ----
    oc : opencode - https://opencode.ai
    oc install                          Install and configure Opencode.
    oc uninstall                        Uninstall Opencode (keeping all configuration unchanged. to remove configuration use 'iatools oc reset' command)
    oc configure                        Configure Opencode. ('iatools oc install' include configuration)
    oc show-config                      Show current Opencode configuration.
    oc reset                            Reset all Opencode configuration.
    oc launch [context folder] -- <other opencode options>                   Launch Opencode.
    oc mcp calculator install|uninstall         Add mcp-calculator local server configuration.
    oc mcp github install|uninstall             Add mcp-github remote server configuration.
    oc mcp context7 install|uninstall           Add mcp-context7 local server configuration.
    ----
    npm-config set <key> <value>    Set a npm configuration for the internal nodejs.
    ----
EOF
}


# Main function
main() {
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        usage
        exit 0
    fi

    if [ "$#" -eq 0 ]; then
        usage
        exit 1
    fi

    local command="$1"
    shift
    case "$command" in
        help)
            usage
            exit 0
            ;;
        shell)
            $STELLA_API boot_app_shell "local"
            ;;
        init)
            iatools_init
            ;;
        npm-config)
            if ! check_requirements "nodejs"; then echo " -- ERROR : nodejs missing, launch iatools init"; exit 1; fi;
            local sub_command="$1"
            shift
            case "$sub_command" in
                set)
                    local key="$1"
                    shift
                    local value="$1"
                    shift
                    if [ -z "$key" ]; then
                        echo " -- ERROR : Missing key for npm-config set"
                        usage
                        exit 1
                    fi
                    echo "Setting npm config: $key = $value"
                    PATH="${IATOOLS_NODEJS_BIN_PATH}:${PATH}" npm config set "$key" "$value" -g
                    ;;
                *)
                    echo "Error: Unknown command $sub_command for npm-config"
                    usage
                    exit 1
                    ;;
            esac
            ;;
        oc)
            . "${_CURRENT_FILE_DIR}/lib/main_oc.sh"
            ;;
        gc)
            . "${_CURRENT_FILE_DIR}/lib/main_gc.sh"
            ;;
        *)
            echo "Error: Unknown command $command"
            usage
            exit 1
            ;;
    esac

    
}


iatools_path
runtime_path

main "$@"

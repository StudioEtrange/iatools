#!/bin/bash
_CURRENT_FILE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
_CURRENT_RUNNING_DIR="$( cd "$( dirname "." )" && pwd )"

#STELLA_LOG_STATE="OFF"
. "${_CURRENT_FILE_DIR}/stella-link.sh" include

. "${_CURRENT_FILE_DIR}/lib/lib.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_json.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_yaml.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_cpa.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_vscode.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_gemini.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_opencode.sh"
. "${_CURRENT_FILE_DIR}/lib/lib_mcp.sh"

# --- USAGE ---
usage() {
    cat << EOF
IATools

Usage: iatools [options]

Options:
    init                    Install/Reinstall dependencies.
    help                    Display this help message.
    shell                   Enter iatools context and path.
    ----
    gc : gemini-cli - https://google-gemini.github.io/gemini-cli
    gc install [@version]           Install and configure Gemini CLI. (main versions are latest, nightly, preview) (when asked to relaunch gemini cli, use 'iatools gc launch' command)
    gc uninstall                    Uninstalling Gemini CLI and unregister Gemini CLI PATH (keep all configuration unchanged, to remove configuration use 'iatools gc reset' command)
    gc configure                    Configure Gemini CLI. ('iatools gc install' include configuration)
    gc show-config                  Show current Gemini CLI configuration.
    gc reset                        Reset all Gemini CLI configuration.
    gc register <shell>|vs          Register Gemini CLI PATH into shell env PATH ("bash", "zsh" or "fish") or into VS Code "vs" integrated terminal env PATH
    gc unregister <shell>|vs        Unregister Gemini CLI PATH into shell env PATH ("bash", "zsh", "fish" or "all") or into VS Code "vs" integrated terminal env PATH
    gc launch [context folder] -- <other gemini options>                  
                                    Launch Gemini CLI. You can use 'gemini' command in your terminal
                                    put in your PATH ${IATOOLS_GEMINI_LAUNCHER_HOME}
                                    done by default in vscode terminal.
    gc mcp calculator install|uninstall         Add mcp-calculator local server configuration.
    gc mcp github install|uninstall             Add mcp-github remote server configuration.
    gc mcp desktop-commander install|uninstall  Add mcp-desktop-commander local server configuration.
    gc mcp context7 install|uninstall   [CONTEXT7_API_KEY]        Add mcp-context7 local server configuration. Provide optional CONTEXT7_API_KEY as environment variable or command argument.
    gc mcp data commons install|uninstall [DC_API_KEY]          Add mcp-data-commons remote server configuration. Provide mandatory DC_API_KEY from https://apikeys.datacommons.org/ as environment variable or command argument.
    ----
    oc : opencode - https://opencode.ai
    oc install                          Install and configure Opencode.
    oc uninstall                        Uninstall Opencode and unregister Opencode PATH (keep all configuration unchanged, to remove configuration use 'iatools oc reset' command)
    oc configure                        Configure Opencode. ('iatools oc install' include configuration)
    oc show-config                      Show current Opencode configuration.
    oc reset                            Reset all Opencode configuration.
    oc register <shell>|vs              Register Opencode PATH into shell env PATH ("bash", "zsh" or "fish") or into VS Code "vs" integrated terminal env PATH
    oc unregister <shell>|vs            Unregister Opencode PATH into shell env PATH ("bash", "zsh", "fish" or "all") or into VS Code "vs" integrated terminal env PATH
    oc launch [context folder] -- <other opencode options>                   Launch Opencode.
    oc mcp calculator install|uninstall         Add mcp-calculator local server configuration.
    oc mcp github install|uninstall             Add mcp-github remote server configuration.
    oc mcp context7 install|uninstall           Add mcp-context7 local server configuration.
    ----
    vs set <key> <value>               Set a VS Code configuration in settings file.
    vs show-config                      Show current VSCode configuration.
    ----
    cpa : CLIProxyAPI - https://github.com/router-for-me/CLIProxyAPI
    cpa install                          Install and configure CLIProxyAPI.
    cpa uninstall                        Uninstall CLIProxyAPI (keeping all configuration unchanged. to remove configuration use 'iatools cpa reset' command)
    cpa configure                        Configure CLIProxyAPI. ('iatools cpa install' include configuration)
    cpa info                             Print CLIProxyAPI informations.
    cpa show-config                      Show current CLIProxyAPI configuration.
    cpa reset                            Reset all CLIProxyAPI configuration.
    cpa launch -- <other opencCLIProxyAPIde options>                   Launch CLIProxyAPI.
    cpa set <key> <value> ["string"]     Set a CLIProxyAPI key in setting file. (i.e: cpa set port 8000) Use optionnal "string" option value is a string.
    cpa get <key>                        Get a CLIProxyAPI key from setting file. (i.e: cpa get api-key.0)
    cpa key generate                     Generate a new API key for CLIProxyAPI and add it to the configuration.
    cpa key list                        List all API keys from CLIProxyAPI configuration. 
    cpa key reset                        Remove all API keys from CLIProxyAPI configuration.
    cpa key delete <key>                 Remove an API key from CLIProxyAPI configuration.
    ----
    npm-config set <key> <value>    Set a npm configuration for the internal nodejs.
    ----
    app killport <port>                Kill process running on a specific port.
    ----
EOF
}


# Main function
main() {
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        usage
        exit 0
    fi

    if [ "$#" -eq 0 ]; then
        usage
        exit 1
    fi

    local command="$1"
    shift
    case "$command" in
        help)
            usage
            exit 0
            ;;
        shell)
            $STELLA_API boot_app_shell "local"
            ;;
        init)
            iatools_init
            ;;
        npm-config)
            if ! check_requirements "nodejs"; then echo " -- ERROR : nodejs missing, launch iatools init"; exit 1; fi;
            local sub_command="$1"
            shift
            case "$sub_command" in
                set)
                    local key="$1"
                    shift
                    local value="$1"
                    shift
                    if [ -z "$key" ]; then
                        echo " -- ERROR : Missing key for npm-config set"
                        usage
                        exit 1
                    fi
                    echo "Setting npm config: $key = $value"
                    PATH="${IATOOLS_NODEJS_BIN_PATH}:${PATH}" npm config set "$key" "$value" -g
                    ;;
                *)
                    echo "Error: Unknown command $sub_command for npm-config"
                    usage
                    exit 1
                    ;;
            esac
            ;;
        app)
            local sub_command="$1"
            shift
            case "$sub_command" in
                killport)
                    local port="$1"
                    shift
                    if [ -z "$port" ]; then
                        echo " -- ERROR : Missing port for app killport"
                        usage
                        exit 1
                    fi
                    process_kill_by_port "$port"
                    ;;
                *)
                    echo "Error: Unknown command $sub_command for app"
                    usage
                    exit 1
                    ;;
            esac
            ;;
        oc)
            . "${_CURRENT_FILE_DIR}/lib/main_oc.sh"
            ;;
        gc)
            . "${_CURRENT_FILE_DIR}/lib/main_gc.sh"
            ;;
        cpa)
            . "${_CURRENT_FILE_DIR}/lib/main_cpa.sh"
            ;;
        vs)
            . "${_CURRENT_FILE_DIR}/lib/main_vs.sh"
            ;;
        *)
            echo "Error: Unknown command $command"
            usage
            exit 1
            ;;
    esac

    
}


iatools_path
runtime_path

main "$@"
